<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlueAI 1.2 – AI Copilot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #02081a;
      --bg-elevated: #020b24;
      --accent: #2563eb;
      --accent-2: #4f46e5;
      --accent-soft: rgba(37, 99, 235, 0.18);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-strong: 0 30px 80px rgba(15, 23, 42, 0.95);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #020617 0, #000 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    /* AUTH SCREEN */

    .auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617 0, #000 60%);
      z-index: 50;
    }

    .auth-shell {
      width: 100%;
      max-width: 960px;
      padding: 24px;
    }

    .auth-card {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 20px;
      border-radius: 28px;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 100%);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-strong);
      overflow: hidden;
      position: relative;
    }

    .auth-left {
      padding: 26px 26px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.25), #020617 55%);
    }

    .auth-brand-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #0ea5e9, #2563eb, #4f46e5, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 18px 40px rgba(37, 99, 235, 0.9);
    }

    .brand-logo-inner {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #1d4ed8 45%, #020617 100%);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .brand-text-main {
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.2);
      border: 1px solid rgba(96, 165, 250, 0.6);
      color: #bfdbfe;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .auth-title {
      font-size: 22px;
      font-weight: 500;
    }

    .auth-sub {
      font-size: 13px;
      color: var(--text-soft);
      max-width: 420px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    .auth-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .auth-input {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 9px 13px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }

    .auth-input::placeholder {
      color: #6b7280;
    }

    .auth-btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .auth-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 14px 32px rgba(37, 99, 235, 0.9);
      white-space: nowrap;
    }

    .auth-btn.secondary {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text);
      box-shadow: none;
    }

    .auth-message {
      font-size: 11px;
      margin-top: 4px;
      min-height: 14px;
    }

    .auth-message.error {
      color: var(--danger);
    }

    .auth-message.success {
      color: var(--success);
    }

    .auth-meta-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      flex-wrap: wrap;
    }

    .auth-chip {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .auth-chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .auth-right {
      padding: 26px 24px 22px 0;
      position: relative;
      overflow: hidden;
    }

    .auth-right-card {
      border-radius: 20px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), #020617);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 14px 14px 12px 14px;
      box-shadow: var(--shadow-soft);
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .auth-right-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .auth-right-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .auth-right-pill {
      border-radius: 999px;
      padding: 6px 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .auth-right-pill-label {
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
    }

    .auth-right-pill-value {
      color: var(--text);
    }

    .auth-right-footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 800px) {
      .auth-card {
        grid-template-columns: minmax(0, 1fr);
      }
      .auth-right {
        padding: 0 18px 18px 18px;
      }
    }

    /* APP SHELL */

    .app-shell {
      display: none;
      width: 100%;
      max-width: 1280px;
      margin: 20px;
      border-radius: 26px;
      overflow: hidden;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 100%);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-strong);
      display: none;
    }

    .app-shell-inner {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 260px;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-right: 1px solid rgba(148, 163, 184, 0.2);
      padding: 18px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sidebar-brand-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .sidebar-brand-text-main {
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sidebar-brand-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), rgba(15, 23, 42, 0.95));
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .chip-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #9ca3af;
    }

    .sidebar-card {
      border-radius: 18px;
      padding: 12px 12px 10px 12px;
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-soft);
      font-size: 12px;
      color: var(--text-soft);
    }

    .sidebar-card-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--text);
    }

    .sidebar-metric-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .sidebar-metric {
      flex: 1;
      border-radius: 999px;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-metric-label {
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .sidebar-metric-value {
      color: var(--text);
      font-size: 11px;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .sidebar-footer span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .logout-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .logout-btn:hover {
      background: rgba(31, 41, 55, 0.95);
    }

    /* MAIN */

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 16px 14px 16px;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .main-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .main-title span:first-child {
      font-size: 18px;
      font-weight: 500;
    }

    .main-title span:last-child {
      font-size: 12px;
      color: var(--text-soft);
    }

    .model-pill {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(96, 165, 250, 0.7);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.3), rgba(15, 23, 42, 0.98));
      color: #dbeafe;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.9);
    }

    .model-pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* CHAT PANEL */

    .chat-shell {
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), #020617);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      flex: 1;
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      padding: 14px 16px 10px 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .chat-message {
      display: flex;
      gap: 10px;
      max-width: 90%;
    }

    .chat-message.user {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #1d4ed8 45%, #020617 100%);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
      flex-shrink: 0;
    }

    .avatar.user {
      background: radial-gradient(circle at 30% 20%, #f97316 0, #ea580c 45%, #020617 100%);
    }

    .bubble {
      border-radius: 16px;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.4;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.97);
      color: var(--text);
      position: relative;
      white-space: pre-wrap;
    }

    .chat-message.user .bubble {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(79, 70, 229, 0.95));
      border-color: rgba(129, 140, 248, 0.95);
    }

    .bubble img {
      max-width: 260px;
      border-radius: 12px;
      margin-top: 6px;
      display: block;
    }

    .bubble-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .bubble-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .bubble-tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .chat-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 13px;
      color: var(--text-soft);
      padding: 0 40px;
    }

    .chat-empty span {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #6b7280;
    }

    .chat-input-row {
      padding: 10px 12px 10px 12px;
      border-top: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), #020617);
    }

    .chat-input-main {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.97);
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }

    .chat-input::placeholder {
      color: #6b7280;
    }

    .chat-send-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.9);
      white-space: nowrap;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .chat-input-meta {
      font-size: 10px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-input-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #9ca3af;
      animation: pulse 1.2s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.3;
        transform: translateY(0);
      }
      50% {
      opacity: 1;
      transform: translateY(-2px);
      }
    }

    @media (max-width: 980px) {
      .app-shell {
        margin: 0;
        border-radius: 0;
      }
      .sidebar {
        width: 230px;
      }
    }

    @media (max-width: 780px) {
      .app-shell-inner {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
    }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div class="auth-screen" id="authScreen">
    <div class="auth-shell">
      <div class="auth-card">
        <div class="auth-left">
          <div class="auth-brand-row">
            <div class="brand-logo">
              <div class="brand-logo-inner"></div>
            </div>
            <div>
              <div class="brand-text-main">
                BlueAI
                <span class="brand-badge">Model 1.2</span>
              </div>
              <div class="brand-sub">Your personal AI copilot</div>
            </div>
          </div>

          <div>
            <div class="auth-title">Sign in to BlueAI 1.2</div>
            <div class="auth-sub">
              Use your account so BlueAI can store your chat history securely in Firebase.
            </div>
          </div>

          <form class="auth-form" id="authForm">
            <div>
              <div class="auth-label">Email</div>
              <input
                type="email"
                id="emailInput"
                class="auth-input"
                placeholder="you@example.com"
                required
              />
            </div>
            <div>
              <div class="auth-label">Password</div>
              <input
                type="password"
                id="passwordInput"
                class="auth-input"
                placeholder="At least 6 characters"
                required
              />
            </div>
            <div class="auth-btn-row">
              <button type="submit" class="auth-btn" id="loginBtn">
                Sign in
              </button>
              <button type="button" class="auth-btn secondary" id="registerBtn">
                Register
              </button>
            </div>
            <div class="auth-message" id="authMessage"></div>
          </form>

          <div class="auth-meta-row">
            <div class="auth-chip">
              <span class="auth-chip-dot"></span>
              Firebase Auth & Realtime Database
            </div>
            <div class="auth-chip">
              BlueAI stores data per user ID
            </div>
          </div>
        </div>

        <div class="auth-right">
          <div class="auth-right-card">
            <div class="auth-right-title">What BlueAI 1.2 can do</div>
            <div>
              BlueAI 1.2 is your own AI interface: chat, explanations, coding help and image responses directly in the chat.
            </div>
            <div class="auth-right-grid">
              <div class="auth-right-pill">
                <div class="auth-right-pill-label">Chat</div>
                <div class="auth-right-pill-value">Context‑aware answers</div>
              </div>
              <div class="auth-right-pill">
                <div class="auth-right-pill-label">Code</div>
                <div class="auth-right-pill-value">Explains & writes snippets</div>
              </div>
              <div class="auth-right-pill">
                <div class="auth-right-pill-label">Images</div>
                <div class="auth-right-pill-value">Generates images from prompts</div>
              </div>
              <div class="auth-right-pill">
                <div class="auth-right-pill-label">Hosting</div>
                <div class="auth-right-pill-value">Single file, Netlify‑ready</div>
              </div>
            </div>
            <div class="auth-right-footer">
              After login you land in the BlueAI console with a clean chat interface.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div class="app-shell" id="appShell">
    <div class="app-shell-inner">
      <aside class="sidebar">
        <div class="sidebar-brand-row">
          <div class="brand-logo">
            <div class="brand-logo-inner"></div>
          </div>
          <div>
            <div class="sidebar-brand-text-main">
              BlueAI
              <span class="brand-badge">1.2</span>
            </div>
            <div class="sidebar-brand-sub">Copilot console</div>
          </div>
        </div>

        <div>
          <div class="sidebar-section-title">Modes & capabilities</div>
          <div class="chip-row">
            <div class="chip">
              <span class="chip-dot"></span>
              Chat & explanations
            </div>
            <div class="chip">
              Coding help
              <span class="chip-pill">JS / pseudo</span>
            </div>
            <div class="chip">
              Image replies
              <span class="chip-pill">Prompt → image</span>
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <div class="sidebar-card-title">BlueAI 1.2 session</div>
          <div>
            Your messages are stored in your private history and used as context for better answers.
          </div>
          <div class="sidebar-metric-row">
            <div class="sidebar-metric">
              <div class="sidebar-metric-label">Messages</div>
              <div class="sidebar-metric-value" id="metric-turns">0</div>
            </div>
            <div class="sidebar-metric">
              <div class="sidebar-metric-label">Images</div>
              <div class="sidebar-metric-value" id="metric-images">0</div>
            </div>
          </div>
        </div>

        <div class="sidebar-footer">
          <span>
            <span class="status-dot"></span>
            BlueAI 1.2 is ready.
          </span>
          <button class="logout-btn" id="logoutBtn">
            ⎋ Sign out
          </button>
          <span id="userInfo"></span>
        </div>
      </aside>

      <main class="main">
        <header class="main-header">
          <div class="main-title">
            <span>BlueAI Copilot chat</span>
            <span>Ask anything: explanations, code, prompts, images.</span>
          </div>
          <div class="model-pill">
            <span class="model-pill-dot"></span>
            BlueAI 1.2 · multimodal‑style
          </div>
        </header>

        <section class="chat-shell">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty" id="chatEmpty">
              Welcome to the BlueAI chat.<br />
              <span>
                Try: “Explain async/await”, “Generate an image of a neon city”, or “Help me debug this code”.
              </span>
            </div>
          </div>
          <div class="chat-input-row">
            <div class="chat-input-main">
              <input
                type="text"
                id="chatInput"
                class="chat-input"
                placeholder="Ask BlueAI anything…"
              />
              <button class="chat-send-btn" id="sendBtn">
                Send
              </button>
            </div>
            <div class="chat-input-meta">
              <span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                BlueAI 1.2 generates answers and images.
              </span>
              <span id="chatMetaHint">
                History is stored in Firebase per user.
              </span>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script type="module">
    // Firebase v10 modular via CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      serverTimestamp,
      set,
      get,
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDFFwtjglnwOc5gITw3FgQYP5vhaicWlIQ",
      authDomain: "blueai-eb780.firebaseapp.com",
      databaseURL: "https://blueai-eb780-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "blueai-eb780",
      storageBucket: "blueai-eb780.firebasestorage.app",
      messagingSenderId: "802037300238",
      appId: "1:802037300238:web:1a3dadb0e899a4721a105f",
      measurementId: "G-DC08K7LNRV",
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- Gemini config (hidden in UI, but frontend can’t fully hide keys) ---
    const GEMINI_API_KEY = "AIzaSyC6b1TNa5C6sdcrqe-59d2STxpj_XGnUaU";
    const GEMINI_TEXT_MODEL =
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent";
    const GEMINI_IMAGE_MODEL =
      "https://generativelanguage.googleapis.com/v1beta/models/imagegeneration:generateImage";

    // AUTH UI
    const authScreen = document.getElementById("authScreen");
    const appShell = document.getElementById("appShell");
    const authForm = document.getElementById("authForm");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const authMessage = document.getElementById("authMessage");

    // APP UI
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const metricTurns = document.getElementById("metric-turns");
    const metricImages = document.getElementById("metric-images");

    const chatMessages = document.getElementById("chatMessages");
    const chatEmpty = document.getElementById("chatEmpty");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    let currentUser = null;
    let messageCount = 0;
    let imageCount = 0;
    let isGenerating = false;
    let historyCache = [];

    function setAuthMessage(text, type = "error") {
      authMessage.textContent = text;
      authMessage.className = "auth-message " + (type === "error" ? "error" : "success");
    }

    function clearAuthMessage() {
      authMessage.textContent = "";
      authMessage.className = "auth-message";
    }

    function showApp(user) {
      currentUser = user;
      authScreen.style.display = "none";
      appShell.style.display = "block";
      userInfo.textContent = "Signed in as: " + (user.email || user.uid);
      loadChatHistory();
    }

    function showAuth() {
      currentUser = null;
      authScreen.style.display = "flex";
      appShell.style.display = "none";
      userInfo.textContent = "";
      clearChatUI();
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        showApp(user);
      } else {
        showAuth();
      }
    });

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAuthMessage();
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        setAuthMessage("Please enter email and password.");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        setAuthMessage("Signed in successfully.", "success");
      } catch (err) {
        setAuthMessage("Sign in failed: " + (err.message || err.code));
      }
    });

    registerBtn.addEventListener("click", async () => {
      clearAuthMessage();
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        setAuthMessage("Please enter email and password.");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        setAuthMessage("Account created and signed in.", "success");
      } catch (err) {
        setAuthMessage("Registration failed: " + (err.message || err.code));
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // CHAT UI

    function clearChatUI() {
      chatMessages.innerHTML = "";
      chatMessages.appendChild(chatEmpty);
      messageCount = 0;
      imageCount = 0;
      metricTurns.textContent = "0";
      metricImages.textContent = "0";
      historyCache = [];
    }

    function appendMessage({ from, text, meta, tag, imageDataUrl }) {
      if (chatEmpty.parentElement === chatMessages) {
        chatEmpty.remove();
      }
      const wrapper = document.createElement("div");
      wrapper.className = "chat-message " + (from === "user" ? "user" : "assistant");

      const avatar = document.createElement("div");
      avatar.className = "avatar" + (from === "user" ? " user" : "");

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (text) {
        bubble.textContent = text;
      }

      if (imageDataUrl) {
        const img = document.createElement("img");
        img.src = imageDataUrl;
        img.alt = "Generated by BlueAI";
        bubble.appendChild(img);
      }

      if (meta || tag) {
        const metaDiv = document.createElement("div");
        metaDiv.className = "bubble-meta";
        metaDiv.textContent = meta || "";
        bubble.appendChild(metaDiv);
      }

      if (tag) {
        const tagDiv = document.createElement("div");
        tagDiv.className = "bubble-tag";
        const dot = document.createElement("span");
        dot.className = "bubble-tag-dot";
        tagDiv.appendChild(dot);
        const label = document.createElement("span");
        label.textContent = tag;
        tagDiv.appendChild(label);
        bubble.appendChild(tagDiv);
      }

      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (from === "user" || from === "assistant") {
        messageCount++;
        metricTurns.textContent = String(messageCount);
      }
    }

    function addTypingIndicator() {
      const wrapper = document.createElement("div");
      wrapper.className = "chat-message assistant";
      wrapper.id = "typingIndicator";

      const avatar = document.createElement("div");
      avatar.className = "avatar";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      const dots = document.createElement("div");
      dots.style.display = "inline-flex";
      dots.style.gap = "4px";
      ["", "", ""].forEach(() => {
        const d = document.createElement("span");
        d.className = "typing-dot";
        dots.appendChild(d);
      });
      bubble.appendChild(dots);

      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      const el = document.getElementById("typingIndicator");
      if (el) el.remove();
    }

    async function saveMessageToDB(userId, message) {
      try {
        const chatRef = ref(db, "chats/" + userId);
        const newRef = push(chatRef);
        await set(newRef, {
          from: message.from,
          text: message.text || "",
          image: message.image || null,
          createdAt: serverTimestamp(),
        });
      } catch (e) {
        console.warn("Error saving chat message:", e);
      }
    }

    async function loadChatHistory() {
      if (!currentUser) return;
      clearChatUI();
      try {
        const chatRef = ref(db, "chats/" + currentUser.uid);
        const snap = await get(chatRef);
        if (snap.exists()) {
          const data = snap.val();
          const entries = Object.values(data).sort((a, b) => {
            const ta = a.createdAt || 0;
            const tb = b.createdAt || 0;
            return ta - tb;
          });
          entries.forEach((msg) => {
            appendMessage({
              from: msg.from,
              text: msg.text,
              meta: msg.from === "user" ? "You" : "BlueAI 1.2",
              tag: msg.image ? "Image" : "Conversation",
              imageDataUrl: msg.image || undefined,
            });
            historyCache.push({ from: msg.from, text: msg.text });
            if (msg.image) {
              imageCount++;
            }
          });
          metricImages.textContent = String(imageCount);
        }
      } catch (e) {
        console.warn("Error loading history:", e);
      }
    }

    // GEMINI CALLS

    async function callGeminiText(prompt, history) {
      const messages = history.slice(-8).map((m) => ({
        role: m.from === "user" ? "user" : "model",
        parts: [{ text: m.text }],
      }));
      messages.push({ role: "user", parts: [{ text: prompt }] });

      const body = {
        contents: messages,
      };

      const res = await fetch(GEMINI_TEXT_MODEL + "?key=" + GEMINI_API_KEY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("Gemini text error: " + res.status);
      }

      const data = await res.json();
      const candidates = data.candidates || [];
      const first = candidates[0];
      if (!first || !first.content || !first.content.parts) {
        return "I couldn’t generate a response right now.";
      }
      const textParts = first.content.parts
        .filter((p) => p.text)
        .map((p) => p.text)
        .join("\n");
      return textParts || "I couldn’t generate a response right now.";
    }

    async function callGeminiImage(prompt) {
      const body = {
        prompt: {
          text: prompt,
        },
        // simple config
        imageGenerationConfig: {
          numberOfImages: 1,
          aspectRatio: "4:3",
        },
      };

      const res = await fetch(GEMINI_IMAGE_MODEL + "?key=" + GEMINI_API_KEY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("Gemini image error: " + res.status);
      }

      const data = await res.json();
      const images = data.images || data.generatedImages || data.candidates || [];
      // API shape can vary; we try a few common patterns
      let base64 = null;

      if (Array.isArray(images) && images.length > 0) {
        const img = images[0];
        if (img.base64) base64 = img.base64;
        if (img.image && img.image.base64) base64 = img.image.base64;
      }

      if (!base64 && data.image && data.image.base64) {
        base64 = data.image.base64;
      }

      if (!base64) {
        throw new Error("No image data returned.");
      }

      return "data:image/png;base64," + base64;
    }

    function looksLikeImagePrompt(text) {
      const lower = text.toLowerCase();
      return (
        lower.includes("generate an image") ||
        lower.includes("draw") ||
        lower.includes("create an image") ||
        lower.includes("picture of") ||
        lower.includes("image of") ||
        lower.includes("logo of") ||
        lower.includes("poster of") ||
        lower.includes("art of")
      );
    }

    async function handleSend() {
      if (!currentUser || isGenerating) return;
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";

      appendMessage({
        from: "user",
        text,
        meta: "You",
      });
      historyCache.push({ from: "user", text });
      await saveMessageToDB(currentUser.uid, { from: "user", text });

      isGenerating = true;
      sendBtn.disabled = true;
      addTypingIndicator();

      try {
        let imageDataUrl = null;
        let answerText = "";

        const wantsImage = looksLikeImagePrompt(text);

        if (wantsImage) {
          // First get a short description from Gemini text (for better image prompt)
          const promptForImage =
            "Create a concise, visual description for an image based on this request (no extra text, just the description): " +
            text;
          const visualDesc = await callGeminiText(promptForImage, historyCache);
          // Then call image model
          try {
            imageDataUrl = await callGeminiImage(visualDesc);
            imageCount++;
            metricImages.textContent = String(imageCount);
            answerText =
              "Here is an image based on your request:\n\n" + visualDesc.trim();
          } catch (imgErr) {
            console.warn(imgErr);
            answerText =
              "I tried to generate an image, but something went wrong. Here is a text description instead:\n\n" +
              visualDesc.trim();
          }
        } else {
          answerText = await callGeminiText(text, historyCache);
        }

        removeTypingIndicator();
        appendMessage({
          from: "assistant",
          text: answerText,
          meta: "BlueAI 1.2",
          tag: imageDataUrl ? "Image" : "Conversation",
          imageDataUrl,
        });

        historyCache.push({ from: "assistant", text: answerText });
        await saveMessageToDB(currentUser.uid, {
          from: "assistant",
          text: answerText,
          image: imageDataUrl || null,
        });
      } catch (err) {
        console.error(err);
        removeTypingIndicator();
        appendMessage({
          from: "assistant",
          text: "Something went wrong while generating the answer. Please try again.",
          meta: "BlueAI 1.2 · error",
          tag: "Error",
        });
      } finally {
        isGenerating = false;
        sendBtn.disabled = false;
      }
    }

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    sendBtn.addEventListener("click", handleSend);
  </script>
</body>
</html>
